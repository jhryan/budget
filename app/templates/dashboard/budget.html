{% extends 'dashboard/base.html' %}
{% set active_page = 'dashboard.budget' -%}

{% block dashboard_content %}
    <div class="budget-toolbar text-muted p-1">
        <span data-toggle="modal" data-target="#addCategoryGroupModal">
            <span data-feather="plus-circle"></span>
            Category Group
        </span>
    </div>
    <table class="table table-sm">
        <thead>
            <tr>
                <th scope="col">Category</th>
                <th scope="col">Budgeted</th>
                <th scope="col">Activity</th>
                <th scope="col">Available</th>
            </tr>
        </thead>
        {% if category_groups %}
            {% for category_group in category_groups %}
                <tbody id="budget-category-{{ category_group.id }}" class="sortable">
                    <tr class="thead-light nosort" data-id="category-group-{{ category_group.id }}">
                        <th>
                            <span class="expander" data-target=".budget-category-{{ category_group.id }}" data-toggle="collapse" aria-expanded="true">
                                <span data-feather="chevron-down"></span>
                            </span>
                            <span class="category-group-name">
                                <span data-toggle="modal" data-target="#editCategoryGroupModal"> {{ category_group.name }} </span>
                                <span data-toggle="modal" data-target="#addCategoryModal" data-feather="plus-circle"></span>
                            </span>
                        </th>
                        <th>$0.00</td>
                        <th>$0.00</td>
                        <th>$0.00</td>
                    </tr>
                    {% for category in category_group.children %}
                        <tr class="budget-category-{{ category_group.id }} collapse show" data-id="category-{{ category.id }}">
                            <th scope="row" data-toggle="modal" data-target="#editCategoryModal"> {{ category.name }} </th>
                            <td>$0.00</td>
                            <td>$0.00</td>
                            <td>$0.00</td>
                        </tr>
                    {% endfor %}
                </tbody>
            {% endfor %}
        {% endif %}
    </table>

    <!-- 'Add Category Group' modal  -->
    <div class="modal fade" id="addCategoryGroupModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                {% include 'dashboard/add_category_group_form.html' %}
            </div>
        </div>
    </div>

    <!-- 'Edit Category Group' modal  -->
    <div class="modal fade" id="editCategoryGroupModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                {% include 'dashboard/edit_category_group_form.html' %}
            </div>
        </div>
    </div>

    <!-- 'Add Category' modal  -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                {% include 'dashboard/add_category_form.html' %}
            </div>
        </div>
    </div>

    <!-- 'Edit Category Group' modal  -->
    <div class="modal fade" id="editCategoryModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                {% include 'dashboard/edit_category_form.html' %}
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}

    {{ super() }}

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-sortablejs@latest/jquery-sortable.js"></script>

    <script>
        var edit_category_group_default_url;
        var add_category_default_url;
        var edit_category_default_url;

        $(function () {

            // create sortable table rows - whilst freezing/fixing certain rows in place
            var pid, freezed;
            $('.sortable').sortable({
                animation: 150,
                filter: ".nosort",
                group: "category-group",
                onStart: function () {
                    freezed = this.el.querySelector('.nosort');
                },
                onMove: function (event) {  
                    clearTimeout(pid);
                    pid = setTimeout(function () {
                        var list = event.to;

                        if (list.firstElementChild === freezed) {
                            list.insertBefore(freezed, list.children[0]);
                        }
                    }, 0);

                    if (event.related.nextElementSibling === freezed) {
                        return -1;
                    }
                    return freezed !== event.related;
                },
                onAdd: function(event) {
                    var category = $(event.item).find('th').text().trim();
                    var old_category_group = $(event.from).find('.category-group-name').text().trim();
                    var new_category_group = $(event.to).find('.category-group-name').text().trim();

                    $.post( "{{ url_for('dashboard.change_category_group') }}", {
                        'category': category, 
                        'old_category_group': old_category_group, 
                        'new_category_group': new_category_group
                        }
                    );
                },
                store: {
                    /**
                     * Get the order of elements. Called once during initialization.
                     * @param   {Sortable}  sortable
                     * @returns {Array}
                     */
                    get: function (sortable) {
                        var order = localStorage.getItem(sortable.el.id);
                        return order ? order.split('|') : [];
                    },

                    /**
                     * Save the order of elements. Called onEnd (when the item is dropped).
                     * @param {Sortable}  sortable
                     */
                    set: function (sortable) {
                        var order = sortable.toArray();
                        localStorage.setItem(sortable.el.id, order.join('|'));
                    }
                }
            });

            $('#editCategoryGroupModal').on('show.bs.modal', function (event) {
                var category_group = $(event.relatedTarget).text().trim();
                var form = $(event.target).find('form:first');
                edit_category_group_default_url = form.attr('action');
                form.find('label[for="new_category_group"]').text(category_group);
                form.attr('action', $(event.target).find('form:first').attr('action') + '/edit_category_group/' + category_group);
            });

            $('#editCategoryGroupModal').on('hide.bs.modal', function (event) {
                $(event.target).find('form:first').attr('action', edit_category_group_default_url);
            });

            $('#editCategoryGroupModal .btn.btn-danger').on('click', function (event) {
                var form = $(this).closest('form');

                $.post(form.attr('action') + '/delete').done(function (data) {
                    if (typeof data.data !== 'undefined' && data.data.message === 'success') {
                        location.reload();
                    }
                });
            });

            $('#addCategoryModal').on('show.bs.modal', function (event) {
                var category_group = $(event.relatedTarget).parent().text().trim();
                var form = $(event.target).find('form:first');
                add_category_default_url = form.attr('action');
                form.attr('action', form.attr('action') + '/' + category_group + '/add_category');
            });

            $('#addCategoryModal').on('hide.bs.modal', function (event) {
                $(event.target).find('form:first').attr('action', add_category_default_url);
            });

            $('#editCategoryModal').on('show.bs.modal', function (event) {
                var category_group = $(event.relatedTarget).closest('tbody').find('.category-group-name span[data-target="#editCategoryGroupModal"]').text().trim();
                var category = $(event.relatedTarget).text().trim();
                var form = $(event.target).find('form:first');
                edit_category_default_url = form.attr('action');
                form.find('label[for="new_category"]').text(category);
                form.attr('action', form.attr('action') + '/' + category_group + '/edit_category/' + category);
            });

            $('#editCategoryModal').on('hide.bs.modal', function (event) {
                $(event.target).find('form:first').attr('action', edit_category_default_url);
            });

            $('#editCategoryModal .btn.btn-danger').on('click', function (event) {
                var form = $(this).closest('form');

                $.post(form.attr('action') + '/delete').done(function (data) {
                    if (typeof data.data !== 'undefined' && data.data.message === 'success') {
                        location.reload();
                    }
                });
            });
        });

    </script>
{% endblock %}